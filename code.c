#include <stdio.h>

void moving_mean(const int *arr, int arr_len, int k, float *result) {
    for (int i = 0; i <= arr_len - 1; ++i) 
    {
        // int window = k;
        if(i < arr_len -k + 1)
        {
            float sum = 0;
            for (int j = i; j < i + k; ++j) {
                sum += arr[j];
            }
            // printf("gia tri K = %d\n", k);
            result[i] = (float)(sum / k);
            printf("mean data trong ham moving_mean[%d] = %.2f\n",i, result[i]);
        }
        else 
        {
            float sum = 0;
            for(int j = i; j <= arr_len -1; ++j )
            {
                sum += arr[j];
                printf("arr[%d] = %.2f", j, arr[j]);
                
            }
            result[i] = (float)(sum)/(arr_len-i); 
            printf("sum data trong ham k cua so ham sum[%d] = %.2f\n",i, sum);
            printf("mean data trong ham k cua so ham mean[%d] = %.2f\n",i, result[i]);
            printf("arr_len = [%d] va i =[%d] \n",arr_len, i);
        }
    }
}

void moving_median(const float *arr, int arr_len, int k, float *result) {
    for (int i = 0; i <= arr_len - k; ++i) {
        float temp[k];
        for (int j = 0; j < k; ++j) {
            temp[j] = arr[i + j];
        }
        // Sắp xếp mảng tạm thời
        for (int m = 0; m < k - 1; ++m) {
            for (int n = m + 1; n < k; ++n) {
                if (temp[m] > temp[n]) {
                    float temp_val = temp[m];
                    temp[m] = temp[n];
                    temp[n] = temp_val;
                }
            }
        }
        // Tìm giá trị trung vị
        if (k % 2 == 0) {
            result[i] = (temp[k / 2 - 1] + temp[k / 2]) / 2.0;
        } else {
            result[i] = temp[k / 2];
        }
    }
}
/*Tim cac dinh trong mang data*/
void findpeaks(float *arr, int *index)
{
    
}
int main() {
    // Dữ liệu PPG
    // float ppg_data[] = { ... };  // Thay thế [...] bằng dữ liệu PPG của bạn
    // int ppg_data[1000] = {
    //     103081, 97072, 90983, 85933, 82624, 77186, 72064, 66303, 60818, 55563,
    //     49944, 44402, 38795, 33036, 27085, 20987, 15835, 3841, -4402, -12794,
    //     -19012, -25262, -31689, -37455, -43360, -48057, -52968, -59072, -65367,
    //     -71404, -76865, -82544, -88002, -93122, -98377, -102663, -107226, -111541,
    //     -124294, -129566, -133385, -135798, -138441, -140765, -142799, -143236,
    //     -142584, -143217, -144192, -144434, -144121, -144374, -144153, -144131,
    //     -143577, -142421, -141381, -140278, -139146, -136340, -121585, -121497,
    //     -120517, -118489, -116372, -114099, -111624, -107806, -105027, -103171,
    //     -101457, -99605, -98079, -96226, -94946, -94627, -95427, -94516, -92989,
    //     -92130, -90271, -86996, -86469, -87355, -87236, -84392, -82964, -82357,
    //     -82134, -82249, -82839, -84529, -85036, -84338, -81818, -80729, -80477,
    //     -80441, -82152, -83595, -82544, -80947, -80951, -80651, -80984, -81802,
    //     -83911, -83774, -81604, -80592, -80339, -79817, -80192, -80903, -82366,
    //     -81760, -78870, -77687, -76934, -76259, -76530, -78241, -77660, -74889,
    //     -73181, -71969, -70861, -70857, -71942, -72104, -70932, -67642, -65794,
    //     -65027, -64182, -64216, -65556, -63922, -60054, -58341, -57179, -55799,
    //     -54888, -55412, -55908, -54326, -50073, -47919, -46881, -45851, -45327,
    //     -46177, -44986, -41371, -39282, -38120, -36299, -35474, -35828, -36336,
    //     -34241, -30624, -28882, -27337, -25996, -25327, -26439, -25324, -21416,
    //     -19471, -18284, -17309, -16729, -17308, -17034, -15134, -11444, -10005,
    //     -9211, -7937, -7721, -8778, -7506, -3455, -1868, -807, 109, 771, -4, -679,
    //     757, 3918, 5314, 6373, 7228, 6385, 5083, 6688, 9649, 10798, 11490, 12148,
    //     12026, 11054, 10968, 12421, 15453, 16366, 17195, 17338, 16742, 15417, 16577,
    //     19251, 20762, 21258, 21113, 20580, 19597, 18812, 19658, 22398, 23051, 23104,
    //     23528, 22837, 21102, 21765, 24451, 25246, 25578, 25887, 25983, 24013, 23491,
    //     25004, 27268, 28124, 28176, 28044, 27233, 24939, 24896, 27146, 28174, 28874,
    //     29054, 28476, 26794, 25788, 27161, 29634, 29589, 29474, 29649, 28052, 25868,
    //     26349, 28635, 29918, 30149, 30219, 29396, 27079, 26329, 27221, 29638, 29574,
    //     29283, 29041, 28316, 26456, 27317, 29743, 30962, 31239, 31093, 30675, 28837,
    //     28126, 29406, 32343, 33294, 34128, 34535, 34537, 34341, 37071, 41431, 44670,
    //     47648, 50261, 52806, 54404, 57423, 62814, 69931, 75822, 81205, 86359, 90511,
    //     94898, 102384, 110987, 117798, 124375, 130738, 137536, 142526, 148116, 156067,
    //     164875, 172019, 178433, 184579, 189093, 192654, 198544, 205823, 211108, 215142,
    //     218716, 220992, 221930, 225834, 228490, 229661, 230347, 230484, 230010, 227820,
    //     225064, 223256, 221319, 219314, 218849, 216254, 211754, 205579, 202309, 200248,
    //     195988, 190947, 185764, 180386, 173674, 166708, 161216, 157859, 153189, 147514,
    //     141872, 134920, 126703, 120136, 116236, 111986, 105576, 99775, 94022, 86606,
    //     79235, 74003, 70919, 66214, 60838, 55443, 49864, 43211, 38001, 34879, 31054,
    //     26312, 21916, 16824, 11680, 7117, 2756, -2018, -6789, -11712, -16781, -22987,
    //     -29862, -34965, -39841, -44315, -48513, -52766, -54849, -59955, -64024, -67360,
    //     -71316, -74952, -78413, -82476, -86796, -91764, -95326, -97850, -98100, -99822,
    //     -102418, -104557, -108011, -110901, -110809, -109548, -110175, -111035, -111752,
    //     -113192, -115745, -116006, -113754, -112484, -111960, -111821, -111273, -111844,
    //     -112622, -111341, -107756, -105436, -104144, -102632, -101898, -102766, -101411,
    //     -97459, -94969, -93219, -91826, -90967, -91783, -91864, -89964, -86474, -84957,
    //     -83175, -82201, -82617, -83617, -82573, -79711, -78105, -77816, -76535, -76242,
    //     -77718, -78311, -77250, -74761, -74001, -73349, -73401, -74456, -76087, -76174,
    //     -73540, -72562, -72175, -72149, -72786, -74460, -75993, -75528, -72784, -72200,
    //     -71853, -71797, -72827, -74568, -73872, -71216, -69978, -69599, -69683, -70391,
    //     -72069, -73151, -72393, -69202, -68350, -68362, -68318, -68549, -70280, -69934,
    //     -66753, -65261, -63981, -63034, -63022, -64474, -64789, -63751, -60624, -58881,
    //     -58121, -57453, -57473, -58804, -58132, -54937, -53284, -52302, -51232, -50954,
    //     -52044, -52322, -50617, -46631, -45332, -44502, -43156, -43011, -44688, -43589,
    //     -39996, -38047, -36853, -35946, -35762, -36681, -36716, -34876, -31671, -30104,
    //     -28566, -27402, -27654, -29081, -27827, -24494, -23048, -22084, -21203, -20899,
    //     -21922, -21918, -20372, -17405, -16286, -15167, -14189, -14176, -15063, -13506,
    //     -10182, -8969, -8091, -7013, -7056, -8147, -8414, -6819, -4339, -3181, -2179,
    //     -1113, -1244, -2698, -1709, 1244, 2602, 3671, 4138, 4011, 2871, 2738, 4333,
    //     7179, 8118, 8421, 9093, 8778, 7169, 8957, 11804, 12225, 13016, 13693, 13473,
    //     11923, 11493, 12412, 15014, 16315, 16642, 16799, 15797, 14080, 14768, 17183,
    //     18201, 18795, 19198, 18624, 17276, 17003, 18124, 20290, 20786, 20994, 21143,
    //     19904, 17748, 18373, 20763, 21930, 22254, 22543, 21699, 19416, 18517, 19657,
    //     21512, 21711, 21771, 22292, 21397, 19068, 19790, 21621, 21730, 22134, 22100,
    //     21503, 20586, 21696, 22384, 23073, 23324, 23476, 23135, 21903, 20019, 20194,
    //     21009, 22193, 24384, 27415, 27774, 26498, 28883, 29969, 29897, 30339, 31106,
    //     31313, 30529, 30062, 30509, 32754, 36892, 38865, 41018, 42740, 43098, 45684,
    //     50938, 55201, 58726, 62532, 66451, 69598, 72490, 77568, 85056, 91479, 97181,
    //     103170, 108377, 112276, 118060, 126034, 133094, 139846, 145578, 150867, 154961,
    //     158888, 164504, 172259, 178526, 182908, 186923, 190753, 192529, 194964, 199994,
    //     204038, 205507, 206944, 207198, 205856, 204334, 204456, 205874, 205797, 204729,
    //     202551, 199720, 194757, 190757, 189864, 187101, 183169, 179308, 174267, 167987,
    //     161619, 157329, 154721, 150416, 145446, 139826, 133388, 125484, 119696, 116075,
    //     111532, 106328, 101088, 95026, 87768, 81293, 76589, 73324, 69288, 64793, 59853,
    //     54432, 47331, 42219, 39543, 36062, 31553, 27283, 22141, 16379, 10446, 6228,
    //     3833, -440, -4707, -9704, -14769, -20897, -25356, -27312, -30622, -34743, -38539,
    //     -43231, -49530, -54643, -58090, -59559, -62580, -65671, -69031, -72947, -77983,
    //     -80681, -80954, -82973, -84865, -86549, -89055, -92647, -95664, -96426, -94946,
    //     -95546, -96705, -97236, -98448, -100676, -101084, -98444, -97486, -97011, -96787,
    //     -96927, -97809, -98337, -97267, -94540, -92911, -91636, -90479, -90231, -91342,
    //     -90002, -86328, -84397, -83451, -81881, -80673
    // };
    // int ppg_data[100] = {
    //     103081, 97072, 90983, 85933, 82624, 77186, 72064, 66303, 60818, 55563,
    //     49944, 44402, 38795, 33036, 27085, 20987, 15835, 3841, -4402, -12794,
    //     -19012, -25262, -31689, -37455, -43360, -48057, -52968, -59072, -65367,
    //     -71404, -76865, -82544, -88002, -93122, -98377, -102663, -107226, -111541,
    //     -124294, -129566, -133385, -135798, -138441, -140765, -142799, -143236,
    //     -142584, -143217, -144192, -144434, -144121, -144374, -144153, -144131,
    //     -143577, -142421, -141381, -140278, -139146, -136340, -121585, -121497,
    //     -120517, -118489, -116372, -114099, -111624, -107806, -105027, -103171,
    //     -101457, -99605, -98079, -96226, -94946, -94627, -95427, -94516, -92989,
    //     -92130, -90271, -86996, -86469, -87355, -87236, -84392, -82964, -82357};
    int ppg_data[1200];
    int size = (sizeof(ppg_data)/4);
    FILE *file;
    int number;
    
    // Mở tệp để đọc
    file = fopen("ppg_sd.txt", "r");
    
    // Kiểm tra xem tệp có tồn tại không
    if (file == NULL) {
        printf("Không thể mở tệp.\n");
        return 1; // Trả về 1 để báo lỗi
    }

    // Đọc và in giá trị từng số nguyên trong tệp
    int i =0;
    while (fscanf(file, "%d\n", &ppg_data[i]) != EOF) {
        i++;
    }
    for (int i = 0; i < 1200; i++) {
        fprintf(file, "%d\n", ppg_data[i]);  // Ghi mỗi phần tử trên một dòng
        // printf("ppg_data lưu file[%d] = %d\n", i, ppg_data[i]);
    }

    // Đóng tệp sau khi hoàn thành
    fclose(file);
    /*Ghi file vào ppg_data_write*/
    // FILE *file = fopen("ppg_data_write.txt", "w");
    // if (file == NULL) {
    //     printf("Không thể mở tệp để ghi.\n");
    //     return 1;
    // }
    
    
    // // Lưu mảng vào tệp văn bản
    // for (int i = 0; i < size; i++) {
    //     fprintf(file, "%d\n", ppg_data[i]);  // Ghi mỗi phần tử trên một dòng
    //     // printf("ppg_data lưu file[%d] = %d\n", i, ppg_data[i]);
    // }
    // fclose(file);
    //int ppg_data[11] = {1, 2, 3, 4, 5, 6, 7, 8, 9, 10};
    // int ppg_len = (sizeof(ppg_data) / sizeof(int));
    printf("size of ppg1 %d\n", sizeof(ppg_data));
    // printf("size int1 = %d\n", sizeof(int));
    int ppg_len = 1100;
    int windowsize = 10;
    float mean_data[1100] = {1} ;
    // mean_data[ppg_len - windowsize + 2] = {0.0};
    float median_data[ppg_len - windowsize + 2];
    // for (int i = 0; i < (sizeof(mean_data)/4); i++) {
    //     // fprintf(file, "%d\n", mean_data[i]);  // Ghi mỗi phần tử trên một dòng
    //     printf("mean_data 1[%d] = %.2f\n", i, mean_data[i]);
    // }
    printf("sizeof(mean_data) lan 1 = %d\n", sizeof(mean_data));
    // Tính toán moving mean
    moving_mean(ppg_data, ppg_len, windowsize, mean_data);

    // Tính toán moving median
    // moving_median(ppg_data, ppg_len, windowsize, median_data);

    // Tính toán AC_PPG_data
    // float ac_ppg_data[ppg_len - windowsize + 1];
    // for (int i = 0; i < ppg_len - windowsize + 1; ++i) {
    //     ac_ppg_data[i] = median_data[i] - mean_data[i];
    // }

    // In ra kết quả
    // printf("AC_PPG_data: ");
    // for (int i = 0; i < ppg_len - windowsize + 1; ++i) {
    //     printf("%.2f ", ac_ppg_data[i]);
    // }
    // printf("\n");
    int arr[sizeof(mean_data)];
    // Giả sử mảng đã được điều chỉnh ở đây
    printf("sizeof(mean_data) = %d\n", sizeof(mean_data));
    // Mở tệp để ghi
    FILE *file1 = fopen("mean_data.txt", "w");
    if (file1 == NULL) {
        printf("Không thể mở tệp để ghi.\n");
        return 1;
    }
    int size1 = (sizeof(mean_data)/4);
    // Lưu mảng vào tệp văn bản
    for (int i = 0; i < size1; i++) {
        fprintf(file, "%.2f\n", mean_data[i]);  // Ghi mỗi phần tử trên một dòng
        // printf("mean_data lưu file[%d] = %.2f\n", i, mean_data[i]);
    }
    // for (int i = 0; i < (sizeof(ppg_data)/4); i++) {
    //     fprintf(file, "%d\n", mean_data[i]);  // Ghi mỗi phần tử trên một dòng
    //     printf("ppg_data[%d] = %d\n", i, ppg_data[i]);
    // }

    // Đóng tệp
    fclose(file);

    return 0;
}
